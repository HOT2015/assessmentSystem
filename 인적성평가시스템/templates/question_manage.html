{% extends "base.html" %}

{% block title %}문제 관리 - 인적성평가시스템{% endblock %}

{% block page_id %}
<div class="page-id" style="background:#f8f9fa; border-bottom:1px solid #dee2e6; padding:4px 12px; font-size:0.95em; color:#888;">
  화면ID: PAGE-QUESTION-MANAGE (question_manage.html)
</div>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-question-circle"></i> 문제 관리</h2>
            
            <!-- 문제 생성 버튼 -->
            <div class="mb-3">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addQuestionModal">
                    <i class="fas fa-plus"></i> 새 문제 추가
                </button>
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#uploadFileModal">
                    <i class="fas fa-upload"></i> 파일로 문제 추가
                </button>
                <a href="{{ url_for('admin') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> 관리자 페이지로
                </a>
            </div>

            <!-- 문제 목록 -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">문제 목록</h5>
                </div>
                <div class="card-body">
                    <!-- 필터 -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <select id="categoryFilter" class="form-select">
                                <option value="">모든 카테고리</option>
                                <option value="Java">Java</option>
                                <option value="Database">Database</option>
                                <option value="문제해결">문제해결</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select id="typeFilter" class="form-select">
                                <option value="">모든 유형</option>
                                <option value="객관식">객관식</option>
                                <option value="주관식">주관식</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select id="difficultyFilter" class="form-select">
                                <option value="">모든 난이도</option>
                                <option value="초급">초급</option>
                                <option value="중급">중급</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="text" id="searchInput" class="form-control" placeholder="문제 검색...">
                        </div>
                    </div>

                    <!-- 기술 문제 -->
                    <h6 class="text-primary">기술 문제</h6>
                    <div id="technicalQuestions">
                        {% for question in technical_questions %}
                        <div class="question-item card mb-2" data-category="{{ question.category }}" data-type="{{ question.type }}" data-difficulty="{{ question.difficulty }}">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <h6 class="card-title">{{ question.question }}</h6>
                                        <div class="question-meta">
                                            <span class="badge bg-primary">{{ question.category }}</span>
                                            <span class="badge bg-secondary">{{ question.type }}</span>
                                            <span class="badge bg-info">{{ question.difficulty }}</span>
                                            <span class="badge bg-success">{{ question.points }}점</span>
                                        </div>
                                        {% if question.type == "객관식" %}
                                        <div class="mt-2">
                                            <small class="text-muted">선택지:</small>
                                            <ul class="list-unstyled ms-3">
                                                {% for option in question.options %}
                                                <li>{{ loop.index }}. {{ option }}</li>
                                                {% endfor %}
                                            </ul>
                                            <small class="text-success">정답: {{ question.correct_answer }}</small>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <button class="btn btn-sm btn-outline-primary edit-question" data-id="{{ question.id }}">
                                            <i class="fas fa-edit"></i> 수정
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-question" data-id="{{ question.id }}">
                                            <i class="fas fa-trash"></i> 삭제
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- 문제해결 문제 -->
                    <h6 class="text-primary mt-4">문제해결 문제</h6>
                    <div id="problemSolvingQuestions">
                        {% for question in problem_solving_questions %}
                        <div class="question-item card mb-2" data-category="{{ question.category }}" data-type="{{ question.type }}" data-difficulty="{{ question.difficulty }}">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <h6 class="card-title">{{ question.question }}</h6>
                                        <div class="question-meta">
                                            <span class="badge bg-primary">{{ question.category }}</span>
                                            <span class="badge bg-secondary">{{ question.type }}</span>
                                            <span class="badge bg-info">{{ question.difficulty }}</span>
                                            <span class="badge bg-success">{{ question.points }}점</span>
                                        </div>
                                        {% if question.type == "객관식" %}
                                        <div class="mt-2">
                                            <small class="text-muted">선택지:</small>
                                            <ul class="list-unstyled ms-3">
                                                {% for option in question.options %}
                                                <li>{{ loop.index }}. {{ option }}</li>
                                                {% endfor %}
                                            </ul>
                                            <small class="text-success">정답: {{ question.correct_answer }}</small>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <button class="btn btn-sm btn-outline-primary edit-question" data-id="{{ question.id }}">
                                            <i class="fas fa-edit"></i> 수정
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-question" data-id="{{ question.id }}">
                                            <i class="fas fa-trash"></i> 삭제
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 문제 추가 모달: 최상단에 고유ID 표시 -->
<div class="modal fade" id="addQuestionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="page-id" style="background:#f8f9fa; border-bottom:1px solid #dee2e6; padding:4px 12px; font-size:0.95em; color:#888;">
                팝업ID: POPUP-ADD-QUESTION (question_manage.html)
            </div>
            <div class="modal-header">
                <h5 class="modal-title">새 문제 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addQuestionForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">카테고리</label>
                                <select name="category" class="form-select" required>
                                    <option value="">선택하세요</option>
                                    <option value="Java">Java</option>
                                    <option value="Database">Database</option>
                                    <option value="문제해결">문제해결</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">문제 유형</label>
                                <select name="type" class="form-select" required>
                                    <option value="">선택하세요</option>
                                    <option value="객관식">객관식</option>
                                    <option value="주관식">주관식</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">난이도</label>
                                <select name="difficulty" class="form-select" required>
                                    <option value="">선택하세요</option>
                                    <option value="초급">초급</option>
                                    <option value="중급">중급</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">배점</label>
                                <input type="number" name="points" class="form-control" min="1" max="50" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">문제 내용</label>
                        <textarea name="question" class="form-control" rows="3" required></textarea>
                    </div>
                    
                    <!-- 객관식 선택지 -->
                    <div id="optionsSection" style="display:none;">
                        <div class="mb-3">
                            <label class="form-label">선택지</label>
                            <div id="optionsContainer">
                                <div class="input-group mb-2">
                                    <span class="input-group-text">1</span>
                                    <input type="text" name="options[]" class="form-control" placeholder="선택지 1">
                                </div>
                                <div class="input-group mb-2">
                                    <span class="input-group-text">2</span>
                                    <input type="text" name="options[]" class="form-control" placeholder="선택지 2">
                                </div>
                                <div class="input-group mb-2">
                                    <span class="input-group-text">3</span>
                                    <input type="text" name="options[]" class="form-control" placeholder="선택지 3">
                                </div>
                                <div class="input-group mb-2">
                                    <span class="input-group-text">4</span>
                                    <input type="text" name="options[]" class="form-control" placeholder="선택지 4">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">정답</label>
                            <input type="text" name="correct_answer" class="form-control" placeholder="정답을 입력하세요">
                        </div>
                    </div>
                    
                    <!-- 주관식 키워드 -->
                    <div id="keywordsSection" style="display:none;">
                        <div class="mb-3">
                            <label class="form-label">정답 예시</label>
                            <input type="text" name="correct_answer" class="form-control" placeholder="정답 예시를 입력하세요">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">채점 키워드 (쉼표로 구분)</label>
                            <input type="text" name="keywords" class="form-control" placeholder="키워드1, 키워드2, 키워드3">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">추가</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 파일 업로드 모달: 최상단에 고유ID 표시 -->
<div class="modal fade" id="uploadFileModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="page-id" style="background:#f8f9fa; border-bottom:1px solid #dee2e6; padding:4px 12px; font-size:0.95em; color:#888;">
                팝업ID: POPUP-UPLOAD-QUESTION (question_manage.html)
            </div>
            <div class="modal-header">
                <h5 class="modal-title">파일로 문제 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="uploadFileForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">파일 선택</label>
                        <input type="file" name="file" class="form-control" accept=".xlsx,.docx" required>
                        <div class="form-text">Excel(.xlsx) 또는 Word(.docx) 파일을 선택하세요. (최대 10MB)</div>
                    </div>
                    
                    <div class="mb-3">
                        <h6>파일 형식 안내</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">Excel 파일 형식</h6>
                                <small class="text-muted">
                                    첫 번째 시트에 다음 순서로 데이터를 입력하세요:<br>
                                    카테고리 | 유형 | 난이도 | 문제 | 배점 | 선택지1 | 선택지2 | 선택지3 | 선택지4 | 정답
                                </small>
                                <br><br>
                                <a href="{{ url_for('download_sample_excel') }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-download"></i> 샘플 Excel 다운로드
                                </a>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-primary">Word 파일 형식</h6>
                                <small class="text-muted">
                                    각 문제를 다음과 같은 형식으로 작성하세요:<br>
                                    카테고리|유형|난이도|문제내용<br>
                                    문제 상세 내용<br>
                                    1. 선택지1<br>
                                    2. 선택지2<br>
                                    3. 선택지3<br>
                                    4. 선택지4<br>
                                    정답: 정답내용
                                </small>
                                <br><br>
                                <a href="{{ url_for('download_sample_word') }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-download"></i> 샘플 Word 다운로드
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 업로드 진행률 -->
                    <div id="uploadProgress" style="display:none;">
                        <div class="progress mb-3">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="uploadStatus" class="text-muted"></div>
                    </div>
                    
                    <!-- 업로드 결과 -->
                    <div id="uploadResult" style="display:none;">
                        <div id="resultAlert" class="alert">
                            <div id="resultTitle"></div>
                            <div id="resultDetails"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-success" id="uploadBtn">
                        <i class="fas fa-upload"></i> 업로드
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// 문제 유형에 따른 폼 표시/숨김
document.querySelector('select[name="type"]').addEventListener('change', function() {
    const optionsSection = document.getElementById('optionsSection');
    const keywordsSection = document.getElementById('keywordsSection');
    
    if (this.value === '객관식') {
        optionsSection.style.display = 'block';
        keywordsSection.style.display = 'none';
    } else if (this.value === '주관식') {
        optionsSection.style.display = 'none';
        keywordsSection.style.display = 'block';
    } else {
        optionsSection.style.display = 'none';
        keywordsSection.style.display = 'none';
    }
});

// 필터링 기능
function filterQuestions() {
    const categoryFilter = document.getElementById('categoryFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    const difficultyFilter = document.getElementById('difficultyFilter').value;
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    
    const questions = document.querySelectorAll('.question-item');
    
    questions.forEach(question => {
        const category = question.dataset.category;
        const type = question.dataset.type;
        const difficulty = question.dataset.difficulty;
        const questionText = question.querySelector('.card-title').textContent.toLowerCase();
        
        const categoryMatch = !categoryFilter || category === categoryFilter;
        const typeMatch = !typeFilter || type === typeFilter;
        const difficultyMatch = !difficultyFilter || difficulty === difficultyFilter;
        const searchMatch = !searchInput || questionText.includes(searchInput);
        
        if (categoryMatch && typeMatch && difficultyMatch && searchMatch) {
            question.style.display = 'block';
        } else {
            question.style.display = 'none';
        }
    });
}

// 필터 이벤트 리스너
document.getElementById('categoryFilter').addEventListener('change', filterQuestions);
document.getElementById('typeFilter').addEventListener('change', filterQuestions);
document.getElementById('difficultyFilter').addEventListener('change', filterQuestions);
document.getElementById('searchInput').addEventListener('input', filterQuestions);

// 문제 추가 폼 제출
document.getElementById('addQuestionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    // 객관식인 경우 선택지 배열 처리
    if (data.type === '객관식') {
        data.options = Array.from(formData.getAll('options[]')).filter(option => option.trim() !== '');
    }
    
    // 주관식인 경우 키워드 배열 처리
    if (data.type === '주관식') {
        data.keywords = data.keywords.split(',').map(keyword => keyword.trim()).filter(keyword => keyword !== '');
    }
    
    fetch('/admin/questions/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('문제 추가에 실패했습니다: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('문제 추가 중 오류가 발생했습니다.');
    });
});

// 문제 삭제
document.querySelectorAll('.delete-question').forEach(button => {
    button.addEventListener('click', function() {
        if (confirm('정말로 이 문제를 삭제하시겠습니까?')) {
            const questionId = this.dataset.id;
            
            fetch(`/admin/questions/delete/${questionId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('문제 삭제에 실패했습니다: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('문제 삭제 중 오류가 발생했습니다.');
            });
        }
    });
});

// 파일 업로드 폼 제출
document.getElementById('uploadFileForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const uploadBtn = document.getElementById('uploadBtn');
    const progressDiv = document.getElementById('uploadProgress');
    const resultDiv = document.getElementById('uploadResult');
    const progressBar = progressDiv.querySelector('.progress-bar');
    const statusDiv = document.getElementById('uploadStatus');
    
    // 업로드 버튼 비활성화
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 업로드 중...';
    
    // 진행률 표시
    progressDiv.style.display = 'block';
    resultDiv.style.display = 'none';
    progressBar.style.width = '0%';
    statusDiv.textContent = '파일을 업로드하는 중...';
    
    // 업로드 요청
    fetch('/admin/questions/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        progressBar.style.width = '100%';
        statusDiv.textContent = '업로드 완료!';
        
        // 결과 표시
        const resultAlert = document.getElementById('resultAlert');
        const resultTitle = document.getElementById('resultTitle');
        const resultDetails = document.getElementById('resultDetails');
        
        if (data.success) {
            resultAlert.className = 'alert alert-success';
            resultTitle.innerHTML = '<i class="fas fa-check-circle"></i> 업로드 성공!';
            
            let details = `<p>총 ${data.total_questions}개의 문제가 처리되었습니다.</p>`;
            if (data.added_questions > 0) {
                details += `<p><strong>추가된 문제:</strong> ${data.added_questions}개</p>`;
            }
            if (data.updated_questions > 0) {
                details += `<p><strong>업데이트된 문제:</strong> ${data.updated_questions}개</p>`;
            }
            if (data.skipped_questions > 0) {
                details += `<p><strong>건너뛴 문제:</strong> ${data.skipped_questions}개</p>`;
            }
            if (data.errors && data.errors.length > 0) {
                details += `<p><strong>오류:</strong></p><ul>`;
                data.errors.forEach(error => {
                    details += `<li>${error}</li>`;
                });
                details += `</ul>`;
            }
            
            resultDetails.innerHTML = details;
            
            // 성공 시 페이지 새로고침
            setTimeout(() => {
                location.reload();
            }, 3000);
        } else {
            resultAlert.className = 'alert alert-danger';
            resultTitle.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 업로드 실패!';
            resultDetails.innerHTML = `<p>${data.message}</p>`;
            if (data.errors && data.errors.length > 0) {
                resultDetails.innerHTML += `<ul>`;
                data.errors.forEach(error => {
                    resultDetails.innerHTML += `<li>${error}</li>`;
                });
                resultDetails.innerHTML += `</ul>`;
            }
        }
        
        resultDiv.style.display = 'block';
        
        // 업로드 버튼 복원
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-upload"></i> 업로드';
    })
    .catch(error => {
        console.error('Error:', error);
        
        // 오류 결과 표시
        const resultAlert = document.getElementById('resultAlert');
        const resultTitle = document.getElementById('resultTitle');
        const resultDetails = document.getElementById('resultDetails');
        
        resultAlert.className = 'alert alert-danger';
        resultTitle.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 업로드 오류!';
        resultDetails.innerHTML = '<p>파일 업로드 중 오류가 발생했습니다.</p>';
        
        resultDiv.style.display = 'block';
        
        // 업로드 버튼 복원
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-upload"></i> 업로드';
    });
});

// 모달 닫을 때 폼 초기화
document.getElementById('uploadFileModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('uploadFileForm').reset();
    document.getElementById('uploadProgress').style.display = 'none';
    document.getElementById('uploadResult').style.display = 'none';
    document.getElementById('uploadBtn').disabled = false;
    document.getElementById('uploadBtn').innerHTML = '<i class="fas fa-upload"></i> 업로드';
});
</script>
{% endblock %} 