{% extends "base.html" %}

{% block title %}관리자 페이지 - 인적성 평가시스템{% endblock %}

{% block head %}
<style>
.question-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 10px;
    background-color: #f8f9fa;
}

.question-checkbox {
    margin-right: 8px;
}

.form-check-label {
    font-size: 0.875rem;
    line-height: 1.4;
}

.accordion-button {
    padding: 0.75rem 1rem;
    font-size: 0.9rem;
}

.accordion-body {
    padding: 1rem;
}

.badge {
    font-size: 0.7rem;
}

.modal-xl {
    max-width: 1200px;
}

#totalRandomCount, #editTotalRandomCount {
    background-color: #e9ecef;
    font-weight: bold;
}

#totalSelectedCount, #editTotalSelectedCount {
    color: #0d6efd;
    font-weight: bold;
}

.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.accordion-item {
    border: 1px solid #dee2e6;
    margin-bottom: 0.5rem;
}

.accordion-button:not(.collapsed) {
    background-color: #e7f1ff;
    color: #0d6efd;
}

.accordion-button:focus {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}
</style>
{% endblock %}

{% block page_id %}
<div class="page-id" style="background:#f8f9fa; border-bottom:1px solid #dee2e6; padding:4px 12px; font-size:0.95em; color:#888;">
  화면ID: PAGE-ADMIN (admin.html)
</div>
{% endblock %}

{% block content %}
<!-- 지원자 추가 모달 -->
<div class="modal fade" id="addCandidateModal" tabindex="-1">
  <div class="modal-dialog" style="max-width:540px;">
    <div class="modal-content">
      <div class="page-id" style="background:#f8f9fa; border-bottom:1px solid #dee2e6; padding:4px 12px; font-size:0.95em; color:#888;">
        팝업ID: POPUP-ADD-CANDIDATE (admin.html)
      </div>
      <form id="addCandidateForm">
        <div class="modal-header">
          <h5 class="modal-title">지원자 사전등록</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">부서</label>
            <select name="department_id" class="form-select" required>
              <option value="">부서 선택</option>
              {% for dept in departments %}
              <option value="{{ dept.id }}">{{ dept.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">이름</label>
            <input type="text" name="name" class="form-control" required>
            <div class="form-text">지원자는 이름만 일치해야 입장 가능</div>
          </div>
          <div class="mb-3">
            <label class="form-label">접속 가능 날짜 (YYYY-MM-DD)</label>
            <input type="date" name="access_date" class="form-control" required>
            <div class="form-text">해당 날짜에만 시험 응시 가능</div>
          </div>
          <div class="mb-3">
            <label class="form-label">문제풀이 시간(분)</label>
            <input type="number" name="test_duration" class="form-control" min="1" value="10">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="submit" class="btn btn-success">등록</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 지원자 수정 모달 -->
<div class="modal fade" id="editCandidateModal" tabindex="-1">
  <div class="modal-dialog" style="max-width:540px;">
    <div class="modal-content">
      <div class="page-id" style="background:#f8f9fa; border-bottom:1px solid #dee2e6; padding:4px 12px; font-size:0.95em; color:#888;">
        팝업ID: POPUP-EDIT-CANDIDATE (admin.html)
      </div>
      <form id="editCandidateForm">
        <div class="modal-header">
          <h5 class="modal-title">지원자 정보 수정</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editCandidateId" name="candidate_id">
          <div class="mb-3">
            <label class="form-label">부서</label>
            <select id="editCandidateDepartment" name="department_id" class="form-select" required>
              <option value="">부서 선택</option>
              {% for dept in departments %}
              <option value="{{ dept.id }}">{{ dept.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">이름</label>
            <input type="text" id="editCandidateName" name="name" class="form-control" required>
            <div class="form-text">지원자는 이름만 일치해야 입장 가능</div>
          </div>
          <div class="mb-3">
            <label class="form-label">접속 가능 날짜 (YYYY-MM-DD)</label>
            <input type="date" id="editCandidateAccessDate" name="access_date" class="form-control" required>
            <div class="form-text">해당 날짜에만 시험 응시 가능</div>
          </div>
          <div class="mb-3">
            <label class="form-label">문제풀이 시간(분)</label>
            <input type="number" id="editCandidateTestDuration" name="test_duration" class="form-control" min="1">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="submit" class="btn btn-primary">수정</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 회사 정보 설정 모달: 최상단에 고유ID 표시 -->
<div class="page-id" style="background:#f8f9fa; border-bottom:1px solid #dee2e6; padding:4px 12px; font-size:0.95em; color:#888;">
  팝업ID: POPUP-COMPANY-SETTINGS (admin.html)
</div>
<div class="modal fade" id="companySettingsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="companySettingsForm" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">회사 정보 설정</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">회사명</label>
                <input type="text" name="company_name" class="form-control" value="{{ config.get('COMPANY_NAME', '') }}" required>
              </div>
              <div class="mb-3">
                <label class="form-label">회사 설명</label>
                <textarea name="company_description" class="form-control" rows="3">{{ config.get('COMPANY_DESCRIPTION', '') }}</textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">로고 이미지</label>
                <input type="file" name="logo_file" class="form-control" accept="image/*">
                <div class="form-text">PNG, JPG, JPEG, GIF, SVG 파일 지원 (최대 2MB)</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">현재 로고 미리보기</label>
                <div class="border rounded p-3 text-center" style="min-height: 150px;">
                  {% if config.get('COMPANY_LOGO') %}
                    <img src="{{ url_for('static', filename='images/' + config.COMPANY_LOGO) }}" 
                         alt="현재 로고" class="img-fluid" style="max-height: 120px;">
                    <p class="mt-2 text-muted">{{ config.COMPANY_LOGO }}</p>
                  {% else %}
                    <i class="fas fa-image fa-3x text-muted"></i>
                    <p class="mt-2 text-muted">로고가 설정되지 않았습니다</p>
                  {% endif %}
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">로고 제거</label>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="remove_logo" id="removeLogo">
                  <label class="form-check-label" for="removeLogo">
                    현재 로고 제거 (기본 아이콘 사용)
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="submit" class="btn btn-primary">저장</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 탭 네비게이션 -->
<ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
      <i class="fas fa-chart-bar"></i> 대시보드
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
      <i class="fas fa-cog"></i> 시스템 설정
    </button>
  </li>
</ul>

<!-- 탭 콘텐츠 -->
<div class="tab-content" id="adminTabContent">
  <!-- 대시보드 탭 -->
  <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
    <!-- 기존 관리자 페이지 내용 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h3 class="card-title mb-4">
                        <i class="fas fa-chart-bar"></i> 관리자 대시보드
                    </h3>
                    
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">총 지원자</h5>
                                    <h3 class="mb-0">{{ candidates|length }}명</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">평가 완료</h5>
                                    <h3 class="mb-0">{{ candidate_results|length }}명</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-dark">
                                <div class="card-body text-center">
                                    <h5 class="card-title">평가 미완료</h5>
                                    <h3 class="mb-0">{{ candidates|length - candidate_results|length }}명</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">평균 점수</h5>
                                    <h3 class="mb-0">
                                        {# 평가 결과가 있을 때만 평균 계산, 없으면 0점 #}
                                        {% if candidate_results and candidate_results|length > 0 %}
                                            {{ "%.1f"|format(candidate_results.values()|map(attribute='result.total_score')|sum / candidate_results|length) }}점
                                        {% else %}
                                            0점
                                        {% endif %}
                                    </h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title mb-4">
                        <i class="fas fa-list"></i> 지원자 목록 및 평가 결과
                    </h4>
                    
                    <!-- 관리 기능 버튼 -->
                    <div class="mb-3">
                        <a href="{{ url_for('question_manage') }}" class="btn btn-primary">
                            <i class="fas fa-question-circle"></i> 문제 관리
                        </a>
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addCandidateModal">
                            <i class="fas fa-user-plus"></i> 지원자 추가
                        </button>
                    </div>
                    
                    {% if candidates %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>순위</th>
                                    <th>이름</th>
                                    <th>이메일</th>
                                    <th>핸드폰번호</th>
                                    <th>부서</th>
                                    <th>접속가능일</th>
                                    <th>상태</th>
                                    <th>총점</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for c in candidates %}
                                <tr data-candidate-id="{{ c.id }}"
                                    data-name="{{ c.name }}"
                                    data-access-date="{{ c.access_date }}"
                                    data-test-duration="{{ c.test_duration }}"
                                    data-department-id="{{ c.department_id or '' }}">
                                    <td>{{ loop.index }}</td>
                                    <td>{{ c.name }}</td>
                                    <td>{{ c.email or '미입력' }}</td>
                                    <td>{{ c.phone or '미입력' }}</td>
                                    <td>
                                      {% set dept_name = '미지정' %}
                                      {% for dept in departments %}
                                        {% if dept.id == c.department_id %}
                                          {% set dept_name = dept.name %}
                                        {% endif %}
                                      {% endfor %}
                                      {{ dept_name }}
                                    </td>
                                    <td>{{ c.created_at_formatted }}</td>
                                    <td>
                                        {% if candidate_results[c.id] %}
                                            <span class="badge bg-success">평가완료</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">미완료</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ candidate_results[c.id].total_score if candidate_results[c.id] else 'N/A' }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary edit-candidate-btn">
                                            <i class="fas fa-edit"></i> 수정
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-candidate-btn">
                                            <i class="fas fa-trash"></i> 삭제
                                        </button>
                                        {% if candidate_results[c.id] %}
                                        <a href="{{ url_for('admin_answer_detail', candidate_id=c.id) }}" class="btn btn-sm btn-outline-info">
                                            <i class="fas fa-file-alt"></i> 결과
                                        </a>
                                        {% endif %}
                                        <button class="btn btn-sm btn-outline-primary candidate-manage-btn" data-id="{{ c.id }}" data-name="{{ c.name }}">
                                            <i class="fas fa-cog"></i> 문제 세트 관리
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">등록된 지원자가 없습니다.</h5>
                        <p class="text-muted">지원자가 등록되면 여기에 표시됩니다.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if candidate_results %}
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-trophy"></i> 상위 5명
                    </h5>
                    <div class="list-group">
                        {% for candidate_id, data in candidate_results.items() %}
                        {% if data.result.rank <= 5 %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ data.result.rank }}위</strong> - {{ data.candidate.name }}
                                <br><small class="text-muted">{{ data.candidate.email }}</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">{{ data.result.total_score }}점</span>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-chart-pie"></i> 점수 분포
                    </h5>
                    <div class="row text-center">
                        <div class="col-4">
                            <h4 class="text-success">
                                {% set excellent = candidate_results.values()|selectattr('result.total_score', '>=', 150)|list|length %}
                                {{ excellent }}
                            </h4>
                            <small class="text-muted">우수 (150점↑)</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-info">
                                {% set good = candidate_results.values()|selectattr('result.total_score', '>=', 120)|selectattr('result.total_score', '<', 150)|list|length %}
                                {{ good }}
                            </h4>
                            <small class="text-muted">양호 (120-149점)</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-warning">
                                {% set normal = candidate_results.values()|selectattr('result.total_score', '>=', 90)|selectattr('result.total_score', '<', 120)|list|length %}
                                {{ normal }}
                            </h4>
                            <small class="text-muted">보통 (90-119점)</small>
                        </div>
                    </div>
                    <div class="row text-center mt-3">
                        <div class="col-12">
                            <h4 class="text-danger">
                                {% set poor = candidate_results.values()|selectattr('result.total_score', '<', 90)|list|length %}
                                {{ poor }}
                            </h4>
                            <small class="text-muted">개선 필요 (90점↓)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
  </div>

  <!-- 시스템 설정 탭 -->
  <div class="tab-pane fade" id="settings" role="tabpanel">
    <div class="row">
      <!-- 부서 관리 -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">부서 관리</h5>
          </div>
          <div class="card-body">
            <form id="addDepartmentForm" class="mb-3">
              <div class="input-group mb-2">
                <input type="text" name="name" class="form-control" placeholder="새 부서명 입력" required>
                <button class="btn btn-primary" type="submit">추가</button>
              </div>
            </form>
            <!-- 등록된 부서 목록 테이블 -->
            <table class="table table-bordered table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th style="width:60px;">#</th>
                  <th>부서명</th>
                  <th style="width:180px;">관리</th>
                </tr>
              </thead>
              <tbody>
                {% for dept in departments %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td>{{ dept.name }}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary assign-questions-btn" data-id="{{ dept.id }}" data-name="{{ dept.name }}">문제할당</button>
                    <button class="btn btn-sm btn-outline-danger delete-department-btn" data-id="{{ dept.id }}">삭제</button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            <div class="form-text text-danger mt-2">부서 삭제 시 해당 부서에 매핑된 문제들은 '미지정' 상태로 남습니다.</div>
          </div>
        </div>
      </div>
      <!-- 문제-지원자 매칭 링크 -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">문제-지원자 관리</h5>
          </div>
          <div class="card-body">
            <p>지원자별로 시험 볼 문제를 직접 선택하고 할당합니다.</p>
            <a href="{{ url_for('candidate_question_match') }}" class="btn btn-primary">
              <i class="fas fa-link"></i> 매칭 페이지로 이동
            </a>
          </div>
        </div>
      </div>
    </div>
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-random"></i> 랜덤 출제 개수 설정</h5>
        <form id="randomConfigForm" class="row g-2 align-items-center">
          <div class="col-auto">
            <label for="javaCountInput" class="form-label mb-0">JAVA 객관식</label>
            <input type="number" id="javaCountInput" class="form-control" min="1" value="10" style="width:80px;">
          </div>
          <div class="col-auto">
            <label for="dbCountInput" class="form-label mb-0">DB 객관식</label>
            <input type="number" id="dbCountInput" class="form-control" min="1" value="3" style="width:80px;">
          </div>
          <div class="col-auto">
            <button type="submit" class="btn btn-primary">저장</button>
          </div>
          <div class="col-auto" id="randomConfigMsg"></div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- 문제 할당 모달 -->
<div class="modal fade" id="assignQuestionsModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><span id="assignDeptName"></span> - 문제 할당</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- 필터 영역 -->
        <div class="row mb-3">
          <div class="col-md-3">
            <select id="filterDepartment" class="form-select form-select-sm">
              <option value="">전체 부서</option>
              <option value="unassigned">미지정</option>
              {% for dept in departments %}
              <option value="{{ dept.id }}">{{ dept.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <select id="filterType" class="form-select form-select-sm">
              <option value="">전체 유형</option>
              <option value="객관식">객관식</option>
              <option value="주관식">주관식</option>
            </select>
          </div>
          <div class="col-md-2">
            <select id="filterCategory" class="form-select form-select-sm">
              <option value="">전체 카테고리</option>
              <option value="Java">Java</option>
              <option value="Database">Database</option>
            </select>
          </div>
          <div class="col-md-5 text-end">
            <button class="btn btn-outline-secondary btn-sm" id="selectAllQuestions">전체선택</button>
            <button class="btn btn-outline-secondary btn-sm" id="deselectAllQuestions">전체해제</button>
          </div>
        </div>
        <!-- 문제 목록 -->
        <div class="question-list border rounded p-2" style="max-height:400px; overflow-y:auto; background:#f8f9fa;">
          <form id="assignQuestionsForm">
            <input type="hidden" name="department_id" id="assignDeptId">
            <div id="assignQuestionsContainer">
              <!-- JS로 문제 체크박스 렌더링 -->
            </div>
          </form>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
        <button type="button" class="btn btn-primary" id="saveAssignQuestionsBtn">저장</button>
      </div>
    </div>
  </div>
</div>

<!-- ========================= -->
<!-- 지원자별 문제 세트 관리 모달 -->
<!-- ========================= -->
<div class="modal fade" id="candidateQuestionsModal" tabindex="-1" aria-labelledby="candidateQuestionsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="candidateQuestionsModalLabel">지원자별 문제 세트 관리</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <strong>지원자:</strong> <span id="modalCandidateName"></span>
        </div>
        <div class="mb-3">
          <button class="btn btn-outline-primary btn-sm" id="randomizeQuestionsBtn">문제 재랜덤</button>
          <button class="btn btn-success btn-sm" id="saveCandidateQuestionsBtn">저장</button>
        </div>
        <div class="question-list border rounded p-2" style="max-height:400px; overflow-y:auto; background:#f8f9fa;">
          <form id="candidateQuestionsForm">
            <input type="hidden" name="candidate_id" id="modalCandidateId">
            <div id="candidateQuestionsContainer">
              <!-- JS로 문제 체크박스 렌더링 -->
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="text-center mt-4">
    <a href="{{ url_for('index') }}" class="btn btn-primary">
        <i class="fas fa-home"></i> 메인으로 돌아가기
    </a>
    <button onclick="window.print()" class="btn btn-secondary">
        <i class="fas fa-print"></i> 결과 출력
    </button>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 지원자 추가 폼 제출
    document.getElementById('addCandidateForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());

        fetch('{{ url_for("add_candidate") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('지원자가 성공적으로 등록되었습니다.');
                window.location.reload();
            } else {
                alert('지원자 등록 실패: ' + result.message);
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('지원자 등록 중 오류가 발생했습니다.');
        });
    });

    // 수정 버튼 클릭 시 모달 열기 및 데이터 채우기
    const editModal = new bootstrap.Modal(document.getElementById('editCandidateModal'));
    document.querySelectorAll('.edit-candidate-btn').forEach(button => {
        button.addEventListener('click', function() {
            const row = this.closest('tr');
            document.getElementById('editCandidateId').value = row.dataset.candidateId;
            document.getElementById('editCandidateName').value = row.dataset.name;
            document.getElementById('editCandidateAccessDate').value = row.dataset.accessDate;
            document.getElementById('editCandidateTestDuration').value = row.dataset.testDuration;
            document.getElementById('editCandidateDepartment').value = row.dataset.departmentId;
            editModal.show();
        });
    });

    // 지원자 수정 폼 제출
    document.getElementById('editCandidateForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        const candidateId = data.candidate_id;

        fetch(`/admin/candidate/edit/${candidateId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('지원자 정보가 수정되었습니다.');
                window.location.reload();
            } else {
                alert('수정 실패: ' + result.message);
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('수정 중 오류가 발생했습니다.');
        });
    });

    // 지원자 삭제 기능
    document.querySelectorAll('.delete-candidate-btn').forEach(button => {
        button.addEventListener('click', function() {
            const row = this.closest('tr');
            const candidateId = row.dataset.candidateId;
            const candidateName = row.dataset.name;

            if (confirm(`'${candidateName}' 지원자를 정말로 삭제하시겠습니까? 관련 데이터가 모두 삭제됩니다.`)) {
                fetch(`/admin/candidate/delete/${candidateId}`, {
                    method: 'DELETE',
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('지원자가 삭제되었습니다.');
                        window.location.reload();
                    } else {
                        alert('삭제 실패: ' + result.message);
                    }
                }).catch(error => {
                    console.error('Error:', error);
                    alert('삭제 중 오류가 발생했습니다.');
                });
            }
        });
    });

    // 회사 정보 설정 폼 제출
    document.getElementById('companySettingsForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch('{{ url_for("update_company_settings") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('회사 정보가 업데이트되었습니다.');
                window.location.reload();
            } else {
                alert('업데이트 실패: ' + data.message);
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('업데이트 중 오류가 발생했습니다.');
        });
    });

    // 부서 추가 폼 제출
    document.getElementById('addDepartmentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const departmentName = this.querySelector('input[name="name"]').value.trim();
        if (!departmentName) {
            alert('부서명을 입력해주세요.');
            return;
        }

        fetch('/admin/departments/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name: departmentName })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('부서가 추가되었습니다.');
                window.location.reload();
            } else {
                alert('추가 실패: ' + result.message);
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('부서 추가 중 오류가 발생했습니다.');
        });
    });

    // 부서 삭제 기능
    document.querySelectorAll('.delete-department-btn').forEach(button => {
        button.addEventListener('click', function() {
            const departmentId = this.dataset.id;
            const departmentName = this.parentElement.innerText.replace('삭제', '').trim();

            if (confirm(`'${departmentName}' 부서를 정말로 삭제하시겠습니까? 해당 부서에 속한 문제들은 '미지정' 상태가 됩니다.`)) {
                fetch(`/admin/departments/delete/${departmentId}`, {
                    method: 'DELETE',
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('부서가 삭제되었습니다.');
                        window.location.reload();
                    } else {
                        alert('삭제 실패: ' + result.message);
                    }
                }).catch(error => {
                    console.error('Error:', error);
                    alert('삭제 중 오류가 발생했습니다.');
                });
            }
        });
    });

    // 문제 할당 모달 이벤트
    document.querySelectorAll('.assign-questions-btn').forEach(button => {
        button.addEventListener('click', function() {
            const departmentId = this.dataset.id;
            const departmentName = this.dataset.name;
            document.getElementById('assignDeptId').value = departmentId;
            document.getElementById('assignDeptName').innerText = departmentName;
            document.getElementById('filterDepartment').value = '';
            document.getElementById('filterType').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('selectAllQuestions').click();
            new bootstrap.Modal(document.getElementById('assignQuestionsModal')).show();
        });
    });

    // 문제 할당 폼 제출
    document.getElementById('assignQuestionsForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        const departmentId = data.department_id;

        fetch(`/admin/departments/assign_questions`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('문제가 성공적으로 할당되었습니다.');
                new bootstrap.Modal(document.getElementById('assignQuestionsModal')).hide();
                window.location.reload();
            } else {
                alert('문제 할당 실패: ' + result.message);
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('문제 할당 중 오류가 발생했습니다.');
        });
    });

    // =========================
    // 문제할당 모달 문제 렌더링
    // =========================
    // 모든 문제 데이터(백엔드에서 전달)
    const allQuestions = JSON.parse('{{ questions|tojson|safe }}');
    const assignQuestionsContainer = document.getElementById('assignQuestionsContainer');
    const filterDepartment = document.getElementById('filterDepartment');
    const filterType = document.getElementById('filterType');
    const filterCategory = document.getElementById('filterCategory');
    const selectAllBtn = document.getElementById('selectAllQuestions');
    const deselectAllBtn = document.getElementById('deselectAllQuestions');

    // 체크박스 렌더링 함수
    function renderQuestions() {
        const deptId = document.getElementById('assignDeptId').value;
        const type = filterType.value;
        const category = filterCategory.value;
        assignQuestionsContainer.innerHTML = '';
        // 필터 조건에 맞는 문제만 표시
        const filtered = allQuestions.filter(q => {
            // 부서 필터: 미지정(빈값/null) or 해당 부서
            const deptMatch = (filterDepartment.value === '' || filterDepartment.value === 'unassigned')
                ? (!q.department_id || q.department_id === null)
                : q.department_id === filterDepartment.value;
            // 실제 할당할 부서 문제만 체크박스 활성화
            const assignable = (q.department_id === deptId || !q.department_id || q.department_id === null);
            const typeMatch = !type || q.type === type;
            const categoryMatch = !category || q.category === category;
            return deptMatch && typeMatch && categoryMatch && assignable;
        });
        if (filtered.length === 0) {
            assignQuestionsContainer.innerHTML = '<div class="text-muted">조건에 맞는 문제가 없습니다.</div>';
            return;
        }
        filtered.forEach(q => {
            // 체크박스 생성
            const checked = (q.department_id === deptId) ? 'checked' : '';
            const html = `<div class="form-check mb-2">
                <input class="form-check-input question-checkbox" type="checkbox" name="question_ids" value="${q.id}" id="qcb_${q.id}" ${checked}>
                <label class="form-check-label" for="qcb_${q.id}">
                    [${q.category}] [${q.type}] [${q.difficulty}] ${q.question}
                </label>
            </div>`;
            assignQuestionsContainer.insertAdjacentHTML('beforeend', html);
        });
    }

    // 모달 열릴 때 렌더링
    document.querySelectorAll('.assign-questions-btn').forEach(button => {
        button.addEventListener('click', function() {
            // ... 기존 코드 ...
            setTimeout(renderQuestions, 100); // 모달 렌더 후 문제 표시
        });
    });
    // 필터 변경 시 렌더링
    filterDepartment.addEventListener('change', renderQuestions);
    filterType.addEventListener('change', renderQuestions);
    filterCategory.addEventListener('change', renderQuestions);
    // 전체선택/전체해제
    selectAllBtn.addEventListener('click', function() {
        assignQuestionsContainer.querySelectorAll('.question-checkbox').forEach(cb => cb.checked = true);
    });
    deselectAllBtn.addEventListener('click', function() {
        assignQuestionsContainer.querySelectorAll('.question-checkbox').forEach(cb => cb.checked = false);
    });

    // 저장 버튼 클릭 시 폼 제출 트리거
    document.getElementById('saveAssignQuestionsBtn').addEventListener('click', function() {
        document.getElementById('assignQuestionsForm').submit();
    });

    // 지원자 목록에 버튼 추가 (예시: .candidate-manage-btn 클래스)
    document.querySelectorAll('.candidate-manage-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const candidateId = this.dataset.id;
            const candidateName = this.dataset.name;
            document.getElementById('modalCandidateId').value = candidateId;
            document.getElementById('modalCandidateName').innerText = candidateName;
            // 문제 세트 불러오기
            fetch(`/api/candidate/${candidateId}/questions`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        renderCandidateQuestions(data.selected_questions);
                    } else {
                        alert('문제 세트 조회 실패: ' + data.message);
                    }
                });
            new bootstrap.Modal(document.getElementById('candidateQuestionsModal')).show();
        });
    });
    // 문제 재랜덤 버튼
    document.getElementById('randomizeQuestionsBtn').addEventListener('click', function() {
        const candidateId = document.getElementById('modalCandidateId').value;
        fetch(`/api/candidate/${candidateId}/questions/randomize`, {method: 'POST'})
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    renderCandidateQuestions(data.selected_questions);
                } else {
                    alert('랜덤 출제 실패: ' + data.message);
                }
            });
    });
    // 문제 세트 저장 버튼
    document.getElementById('saveCandidateQuestionsBtn').addEventListener('click', function() {
        const candidateId = document.getElementById('modalCandidateId').value;
        const checked = Array.from(document.querySelectorAll('#candidateQuestionsContainer input[type="checkbox"]:checked')).map(cb => cb.value);
        fetch(`/api/candidate/${candidateId}/questions/update`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({question_ids: checked})
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert('문제 세트가 저장되었습니다.');
            } else {
                alert('저장 실패: ' + data.message);
            }
        });
    });
    // 문제 세트 렌더링 함수
    function renderCandidateQuestions(selectedIds) {
        // allQuestions는 기존에 백엔드에서 전달된 전체 문제 데이터
        let html = '';
        allQuestions.forEach(q => {
            const checked = selectedIds.includes(q.id) ? 'checked' : '';
            html += `<div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" value="${q.id}" id="candq_${q.id}" ${checked}>
                <label class="form-check-label" for="candq_${q.id}">
                    [${q.category}] [${q.type}] [${q.difficulty}] ${q.question}
                </label>
            </div>`;
        });
        document.getElementById('candidateQuestionsContainer').innerHTML = html;
    }

    // 랜덤 출제 개수 설정 불러오기
    fetch('/api/random_config')
        .then(res => res.json())
        .then(cfg => {
            document.getElementById('javaCountInput').value = cfg.java_count;
            document.getElementById('dbCountInput').value = cfg.db_count;
        });
    // 저장 이벤트
    document.getElementById('randomConfigForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const javaCount = document.getElementById('javaCountInput').value;
        const dbCount = document.getElementById('dbCountInput').value;
        fetch('/api/random_config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({java_count: javaCount, db_count: dbCount})
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById('randomConfigMsg').innerText = '저장되었습니다!';
            } else {
                document.getElementById('randomConfigMsg').innerText = '저장 실패';
            }
            setTimeout(() => { document.getElementById('randomConfigMsg').innerText = ''; }, 2000);
        });
    });
});
</script>
{% endblock %}