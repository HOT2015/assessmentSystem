{% extends "base.html" %}

{% block title %}관리자 페이지 - 인적성 평가시스템{% endblock %}

{% block head %}
<style>
.question-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 10px;
    background-color: #f8f9fa;
}

.question-checkbox {
    margin-right: 8px;
}

.form-check-label {
    font-size: 0.875rem;
    line-height: 1.4;
}

.accordion-button {
    padding: 0.75rem 1rem;
    font-size: 0.9rem;
}

.accordion-body {
    padding: 1rem;
}

.badge {
    font-size: 0.7rem;
}

.modal-xl {
    max-width: 1200px;
}

#totalRandomCount, #editTotalRandomCount {
    background-color: #e9ecef;
    font-weight: bold;
}

#totalSelectedCount, #editTotalSelectedCount {
    color: #0d6efd;
    font-weight: bold;
}

.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.accordion-item {
    border: 1px solid #dee2e6;
    margin-bottom: 0.5rem;
}

.accordion-button:not(.collapsed) {
    background-color: #e7f1ff;
    color: #0d6efd;
}

.accordion-button:focus {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}
</style>
{% endblock %}

{% block page_id %}
<div class="page-id" style="background:#f8f9fa; border-bottom:1px solid #dee2e6; padding:4px 12px; font-size:0.95em; color:#888;">
  화면ID: PAGE-ADMIN (admin.html)
</div>
{% endblock %}

{% block content %}
<!-- 지원자 추가 모달: 최상단에 고유ID 표시 -->
<div class="modal fade" id="addCandidateModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="page-id" style="background:#f8f9fa; border-bottom:1px solid #dee2e6; padding:4px 12px; font-size:0.95em; color:#888;">
        팝업ID: POPUP-ADD-CANDIDATE (admin.html)
      </div>
      <form id="addCandidateForm">
        <div class="modal-header">
          <h5 class="modal-title">지원자 사전등록</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">이름</label>
                <input type="text" name="name" class="form-control" required>
                <div class="form-text">지원자는 이름만 일치해야 입장 가능</div>
              </div>
              <div class="mb-3">
                <label class="form-label">접속 가능 날짜 (YYYY-MM-DD)</label>
                <input type="date" name="access_date" class="form-control" required>
                <div class="form-text">해당 날짜에만 시험 응시 가능</div>
              </div>
              <div class="mb-3">
                <label class="form-label">문제풀이 시간(분)</label>
                <input type="number" name="test_duration" class="form-control" min="1" value="10">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">출제 문제 설정</label>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="question_selection" id="allQuestions" value="all" checked>
                  <label class="form-check-label" for="allQuestions">
                    전체 문제 출제
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="question_selection" id="randomQuestions" value="random">
                  <label class="form-check-label" for="randomQuestions">
                    랜덤 선택
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="question_selection" id="customQuestions" value="custom">
                  <label class="form-check-label" for="customQuestions">
                    직접 선택
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="question_selection" id="noQuestions" value="none">
                  <label class="form-check-label" for="noQuestions">
                    문제 선택 안함
                  </label>
                </div>
              </div>
              
              <!-- 랜덤 선택 옵션 -->
              <div id="randomOptions" style="display:none;">
                <div class="mb-3">
                  <label class="form-label">카테고리별 랜덤 선택</label>
                  <div class="row">
                    <div class="col-6">
                      <label class="form-label">Java 문제</label>
                      <input type="number" name="random_java" class="form-control" min="0" max="10" value="3">
                    </div>
                    <div class="col-6">
                      <label class="form-label">Database 문제</label>
                      <input type="number" name="random_database" class="form-control" min="0" max="10" value="2">
                    </div>
                  </div>
                  <div class="row mt-2">
                    <div class="col-6">
                      <label class="form-label">문제해결 문제</label>
                      <input type="number" name="random_problem_solving" class="form-control" min="0" max="20" value="3">
                    </div>
                    <div class="col-6">
                      <label class="form-label">총 문제 수</label>
                      <input type="text" id="totalRandomCount" class="form-control" readonly>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 직접 선택 옵션 -->
              <div id="customOptions" style="display:none;">
                <div class="mb-3">
                  <label class="form-label">카테고리별 문제 선택</label>
                  <div class="accordion" id="questionAccordion">
                    <!-- Java 문제 -->
                    <div class="accordion-item">
                      <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#javaQuestions">
                          Java 문제 (<span id="javaCount">0</span>개 선택)
                        </button>
                      </h2>
                      <div id="javaQuestions" class="accordion-collapse collapse show" data-bs-parent="#questionAccordion">
                        <div class="accordion-body">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAllJava">
                            <label class="form-check-label" for="selectAllJava">
                              <strong>전체 선택</strong>
                            </label>
                          </div>
                          <hr>
                          <div id="javaQuestionList" class="question-list">
                            <!-- Java 문제 목록이 여기에 동적으로 로드됩니다 -->
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Database 문제 -->
                    <div class="accordion-item">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#databaseQuestions">
                          Database 문제 (<span id="databaseCount">0</span>개 선택)
                        </button>
                      </h2>
                      <div id="databaseQuestions" class="accordion-collapse collapse" data-bs-parent="#questionAccordion">
                        <div class="accordion-body">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAllDatabase">
                            <label class="form-check-label" for="selectAllDatabase">
                              <strong>전체 선택</strong>
                            </label>
                          </div>
                          <hr>
                          <div id="databaseQuestionList" class="question-list">
                            <!-- Database 문제 목록이 여기에 동적으로 로드됩니다 -->
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- 문제해결 문제 -->
                    <div class="accordion-item">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#problemSolvingQuestions">
                          문제해결 문제 (<span id="problemSolvingCount">0</span>개 선택)
                        </button>
                      </h2>
                      <div id="problemSolvingQuestions" class="accordion-collapse collapse" data-bs-parent="#questionAccordion">
                        <div class="accordion-body">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAllProblemSolving">
                            <label class="form-check-label" for="selectAllProblemSolving">
                              <strong>전체 선택</strong>
                            </label>
                          </div>
                          <hr>
                          <div id="problemSolvingQuestionList" class="question-list">
                            <!-- 문제해결 문제 목록이 여기에 동적으로 로드됩니다 -->
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="mt-3">
                    <strong>총 선택된 문제: <span id="totalSelectedCount">0</span>개</strong>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="submit" class="btn btn-success">등록</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 지원자 수정 모달: 최상단에 고유ID 표시 -->
<div class="modal fade" id="editCandidateModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="page-id" style="background:#f8f9fa; border-bottom:1px solid #dee2e6; padding:4px 12px; font-size:0.95em; color:#888;">
        팝업ID: POPUP-EDIT-CANDIDATE (admin.html)
      </div>
      <form id="editCandidateForm">
        <div class="modal-header">
          <h5 class="modal-title">지원자 정보 수정</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editCandidateId" name="candidate_id">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">이름</label>
                <input type="text" id="editCandidateName" name="name" class="form-control" required>
                <div class="form-text">지원자는 이름만 일치해야 입장 가능</div>
              </div>
              <div class="mb-3">
                <label class="form-label">접속 가능 날짜 (YYYY-MM-DD)</label>
                <input type="date" id="editCandidateAccessDate" name="access_date" class="form-control" required>
                <div class="form-text">해당 날짜에만 시험 응시 가능</div>
              </div>
              <div class="mb-3">
                <label class="form-label">문제풀이 시간(분)</label>
                <input type="number" id="editCandidateTestDuration" name="test_duration" class="form-control" min="1" value="10">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">출제 문제 재설정</label>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="edit_question_selection" id="editAllQuestions" value="all" checked>
                  <label class="form-check-label" for="editAllQuestions">
                    전체 문제 출제
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="edit_question_selection" id="editRandomQuestions" value="random">
                  <label class="form-check-label" for="editRandomQuestions">
                    랜덤 선택
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="edit_question_selection" id="editCustomQuestions" value="custom">
                  <label class="form-check-label" for="editCustomQuestions">
                    직접 선택
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="edit_question_selection" id="editNoQuestions" value="none">
                  <label class="form-check-label" for="editNoQuestions">
                    문제 선택 안함
                  </label>
                </div>
              </div>
              
              <!-- 수정용 랜덤 선택 옵션 -->
              <div id="editRandomOptions" style="display:none;">
                <div class="mb-3">
                  <label class="form-label">카테고리별 랜덤 선택</label>
                  <div class="row">
                    <div class="col-6">
                      <label class="form-label">Java 문제</label>
                      <input type="number" name="edit_random_java" class="form-control" min="0" max="10" value="3">
                    </div>
                    <div class="col-6">
                      <label class="form-label">Database 문제</label>
                      <input type="number" name="edit_random_database" class="form-control" min="0" max="10" value="2">
                    </div>
                  </div>
                  <div class="row mt-2">
                    <div class="col-6">
                      <label class="form-label">문제해결 문제</label>
                      <input type="number" name="edit_random_problem_solving" class="form-control" min="0" max="20" value="3">
                    </div>
                    <div class="col-6">
                      <label class="form-label">총 문제 수</label>
                      <input type="text" id="editTotalRandomCount" class="form-control" readonly>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 수정용 직접 선택 옵션 -->
              <div id="editCustomOptions" style="display:none;">
                <div class="mb-3">
                  <label class="form-label">카테고리별 문제 선택</label>
                  <div class="accordion" id="editQuestionAccordion">
                    <!-- Java 문제 -->
                    <div class="accordion-item">
                      <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#editJavaQuestions">
                          Java 문제 (<span id="editJavaCount">0</span>개 선택)
                        </button>
                      </h2>
                      <div id="editJavaQuestions" class="accordion-collapse collapse show" data-bs-parent="#editQuestionAccordion">
                        <div class="accordion-body">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editSelectAllJava">
                            <label class="form-check-label" for="editSelectAllJava">
                              <strong>전체 선택</strong>
                            </label>
                          </div>
                          <hr>
                          <div id="editJavaQuestionList" class="question-list">
                            <!-- Java 문제 목록이 여기에 동적으로 로드됩니다 -->
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Database 문제 -->
                    <div class="accordion-item">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#editDatabaseQuestions">
                          Database 문제 (<span id="editDatabaseCount">0</span>개 선택)
                        </button>
                      </h2>
                      <div id="editDatabaseQuestions" class="accordion-collapse collapse" data-bs-parent="#editQuestionAccordion">
                        <div class="accordion-body">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editSelectAllDatabase">
                            <label class="form-check-label" for="editSelectAllDatabase">
                              <strong>전체 선택</strong>
                            </label>
                          </div>
                          <hr>
                          <div id="editDatabaseQuestionList" class="question-list">
                            <!-- Database 문제 목록이 여기에 동적으로 로드됩니다 -->
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- 문제해결 문제 -->
                    <div class="accordion-item">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#editProblemSolvingQuestions">
                          문제해결 문제 (<span id="editProblemSolvingCount">0</span>개 선택)
                        </button>
                      </h2>
                      <div id="editProblemSolvingQuestions" class="accordion-collapse collapse" data-bs-parent="#editQuestionAccordion">
                        <div class="accordion-body">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editSelectAllProblemSolving">
                            <label class="form-check-label" for="editSelectAllProblemSolving">
                              <strong>전체 선택</strong>
                            </label>
                          </div>
                          <hr>
                          <div id="editProblemSolvingQuestionList" class="question-list">
                            <!-- 문제해결 문제 목록이 여기에 동적으로 로드됩니다 -->
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="mt-3">
                    <strong>총 선택된 문제: <span id="editTotalSelectedCount">0</span>개</strong>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="submit" class="btn btn-primary">수정</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 회사 정보 설정 모달: 최상단에 고유ID 표시 -->
<div class="page-id" style="background:#f8f9fa; border-bottom:1px solid #dee2e6; padding:4px 12px; font-size:0.95em; color:#888;">
  팝업ID: POPUP-COMPANY-SETTINGS (admin.html)
</div>
<div class="modal fade" id="companySettingsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="companySettingsForm" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">회사 정보 설정</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">회사명</label>
                <input type="text" name="company_name" class="form-control" value="{{ config.get('COMPANY_NAME', '') }}" required>
              </div>
              <div class="mb-3">
                <label class="form-label">회사 설명</label>
                <textarea name="company_description" class="form-control" rows="3">{{ config.get('COMPANY_DESCRIPTION', '') }}</textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">로고 이미지</label>
                <input type="file" name="logo_file" class="form-control" accept="image/*">
                <div class="form-text">PNG, JPG, JPEG, GIF, SVG 파일 지원 (최대 2MB)</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">현재 로고 미리보기</label>
                <div class="border rounded p-3 text-center" style="min-height: 150px;">
                  {% if config.get('COMPANY_LOGO') %}
                    <img src="{{ url_for('static', filename='images/' + config.COMPANY_LOGO) }}" 
                         alt="현재 로고" class="img-fluid" style="max-height: 120px;">
                    <p class="mt-2 text-muted">{{ config.COMPANY_LOGO }}</p>
                  {% else %}
                    <i class="fas fa-image fa-3x text-muted"></i>
                    <p class="mt-2 text-muted">로고가 설정되지 않았습니다</p>
                  {% endif %}
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">로고 제거</label>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="remove_logo" id="removeLogo">
                  <label class="form-check-label" for="removeLogo">
                    현재 로고 제거 (기본 아이콘 사용)
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="submit" class="btn btn-primary">저장</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 탭 네비게이션 -->
<ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
      <i class="fas fa-chart-bar"></i> 대시보드
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
      <i class="fas fa-cog"></i> 시스템 설정
    </button>
  </li>
</ul>

<!-- 탭 콘텐츠 -->
<div class="tab-content" id="adminTabContent">
  <!-- 대시보드 탭 -->
  <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
    <!-- 기존 관리자 페이지 내용 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h3 class="card-title mb-4">
                        <i class="fas fa-chart-bar"></i> 관리자 대시보드
                    </h3>
                    
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">총 지원자</h5>
                                    <h3 class="mb-0">{{ candidates|length }}명</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">평가 완료</h5>
                                    <h3 class="mb-0">{{ candidate_results|length }}명</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-dark">
                                <div class="card-body text-center">
                                    <h5 class="card-title">평가 미완료</h5>
                                    <h3 class="mb-0">{{ candidates|length - candidate_results|length }}명</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">평균 점수</h5>
                                    <h3 class="mb-0">
                                        {# 평가 결과가 있을 때만 평균 계산, 없으면 0점 #}
                                        {% if candidate_results and candidate_results|length > 0 %}
                                            {{ "%.1f"|format(candidate_results.values()|map(attribute='result.total_score')|sum / candidate_results|length) }}점
                                        {% else %}
                                            0점
                                        {% endif %}
                                    </h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title mb-4">
                        <i class="fas fa-list"></i> 지원자 목록 및 평가 결과
                    </h4>
                    
                    <!-- 관리 기능 버튼 -->
                    <div class="mb-3">
                        <a href="{{ url_for('question_manage') }}" class="btn btn-primary">
                            <i class="fas fa-question-circle"></i> 문제 관리
                        </a>
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addCandidateModal">
                            <i class="fas fa-user-plus"></i> 지원자 추가
                        </button>
                    </div>
                    
                    {% if candidates %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>순위</th>
                                    <th>이름</th>
                                    <th>이메일</th>
                                    <th>핸드폰번호</th>
                                    <th>등록일시</th>
                                    <th>평가완료시간</th>
                                    <th>기술 점수</th>
                                    <th>문제해결력</th>
                                    <th>총점</th>
                                    <th>평가 상태</th>
                                    <th>평가일시</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for candidate in candidates %}
                                {% set result = candidate_results.get(candidate.id) %}
                                <tr>
                                    <td>
                                        {% if result %}
                                            <span class="badge bg-primary">{{ result.result.rank }}위</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ candidate.name }}</strong>
                                    </td>
                                    <td>{{ candidate.email }}</td>
                                    <td>{{ candidate.phone }}</td>
                                    <td>{{ candidate.created_at[:19] if candidate.created_at else '' }}</td>
                                    <td>
                                        <input type="datetime-local" class="form-control form-control-sm deadline-input" 
                                               data-candidate-id="{{ candidate.id }}" 
                                               value="{{ candidate.test_deadline[:16] if candidate.test_deadline else '' }}" 
                                               style="width: 150px;">
                                    </td>
                                    <td>
                                        {% if result %}
                                            <span class="badge bg-primary">{{ result.result.scores.technical }}점</span>
                                        {% else %}
                                            <span class="text-muted">미평가</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if result %}
                                            <span class="badge bg-warning text-dark">{{ result.result.scores.problem_solving }}점</span>
                                        {% else %}
                                            <span class="text-muted">미평가</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if result %}
                                            <strong>{{ result.result.total_score }}점</strong>
                                        {% else %}
                                            <span class="text-muted">미평가</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if result %}
                                            <span class="badge bg-success">완료</span>
                                        {% else %}
                                            <span class="badge bg-secondary">미완료</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if result %}
                                            {{ result.result.test_date[:19] if result.result.test_date else '' }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary edit-candidate" 
                                                data-candidate-id="{{ candidate.id }}" 
                                                data-candidate-name="{{ candidate.name }}"
                                                data-access-date="{{ candidate.access_date }}"
                                                data-test-duration="{{ candidate.test_duration }}">
                                            <i class="fas fa-edit"></i> 수정
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-candidate" 
                                                data-candidate-id="{{ candidate.id }}" 
                                                data-candidate-name="{{ candidate.name }}">
                                            <i class="fas fa-trash"></i> 삭제
                                        </button>
                                        {% if result %}
                                        <a href="{{ url_for('admin_answer_detail', candidate_id=candidate.id) }}" class="btn btn-sm btn-outline-info mt-1">
                                            <i class="fas fa-file-alt"></i> 답안 상세
                                        </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">등록된 지원자가 없습니다.</h5>
                        <p class="text-muted">지원자가 등록되면 여기에 표시됩니다.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if candidate_results %}
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-trophy"></i> 상위 5명
                    </h5>
                    <div class="list-group">
                        {% for candidate_id, data in candidate_results.items() %}
                        {% if data.result.rank <= 5 %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ data.result.rank }}위</strong> - {{ data.candidate.name }}
                                <br><small class="text-muted">{{ data.candidate.email }}</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">{{ data.result.total_score }}점</span>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-chart-pie"></i> 점수 분포
                    </h5>
                    <div class="row text-center">
                        <div class="col-4">
                            <h4 class="text-success">
                                {% set excellent = candidate_results.values()|selectattr('result.total_score', '>=', 150)|list|length %}
                                {{ excellent }}
                            </h4>
                            <small class="text-muted">우수 (150점↑)</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-info">
                                {% set good = candidate_results.values()|selectattr('result.total_score', '>=', 120)|selectattr('result.total_score', '<', 150)|list|length %}
                                {{ good }}
                            </h4>
                            <small class="text-muted">양호 (120-149점)</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-warning">
                                {% set normal = candidate_results.values()|selectattr('result.total_score', '>=', 90)|selectattr('result.total_score', '<', 120)|list|length %}
                                {{ normal }}
                            </h4>
                            <small class="text-muted">보통 (90-119점)</small>
                        </div>
                    </div>
                    <div class="row text-center mt-3">
                        <div class="col-12">
                            <h4 class="text-danger">
                                {% set poor = candidate_results.values()|selectattr('result.total_score', '<', 90)|list|length %}
                                {{ poor }}
                            </h4>
                            <small class="text-muted">개선 필요 (90점↓)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
  </div>

  <!-- 시스템 설정 탭 -->
  <div class="tab-pane fade" id="settings" role="tabpanel">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <h3 class="card-title mb-4">
              <i class="fas fa-cog"></i> 시스템 설정
            </h3>
            
            <div class="row">
              <div class="col-md-6">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">
                      <i class="fas fa-building"></i> 회사 정보 설정
                    </h5>
                    <p class="card-text">
                      웹사이트에 표시될 회사명, 설명, 로고 이미지를 설정할 수 있습니다.
                    </p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#companySettingsModal">
                      <i class="fas fa-edit"></i> 회사 정보 수정
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">
                      <i class="fas fa-image"></i> 현재 로고 미리보기
                    </h5>
                    <div class="text-center">
                      {% if config.get('COMPANY_LOGO') %}
                        <img src="{{ url_for('static', filename='images/' + config.COMPANY_LOGO) }}" 
                             alt="현재 로고" class="img-fluid" style="max-height: 100px;">
                        <p class="mt-2 text-muted">{{ config.COMPANY_LOGO }}</p>
                      {% else %}
                        <i class="fas fa-image fa-3x text-muted"></i>
                        <p class="mt-2 text-muted">로고가 설정되지 않았습니다</p>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="row mt-4">
              <div class="col-12">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">
                      <i class="fas fa-info-circle"></i> 설정 안내
                    </h5>
                    <ul class="list-unstyled">
                      <li><i class="fas fa-check text-success"></i> 로고 이미지는 PNG, JPG, JPEG, GIF, SVG 형식을 지원합니다.</li>
                      <li><i class="fas fa-check text-success"></i> 권장 이미지 크기: 최대 200px × 80px</li>
                      <li><i class="fas fa-check text-success"></i> 파일 크기는 2MB 이하로 제한됩니다.</li>
                      <li><i class="fas fa-check text-success"></i> 로고를 설정하지 않으면 기본 아이콘이 표시됩니다.</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="text-center mt-4">
    <a href="{{ url_for('index') }}" class="btn btn-primary">
        <i class="fas fa-home"></i> 메인으로 돌아가기
    </a>
    <button onclick="window.print()" class="btn btn-secondary">
        <i class="fas fa-print"></i> 결과 출력
    </button>
</div>
{% endblock %}

{% block scripts %}
<script>
let allQuestions = [];

function fetchQuestionsAndRender(mode) {
    fetch('/api/questions')
    .then(response => response.json())
    .then(questions => {
        allQuestions = questions;
        renderAllCategoryQuestions(mode);
    })
    .catch(error => {
        allQuestions = [];
        renderAllCategoryQuestions(mode);
        alert('문제 목록을 불러오지 못했습니다. 새로고침 해주세요.');
    });
}

function renderAllCategoryQuestions(mode) {
    const prefix = mode === 'edit' ? 'edit' : '';
    // Java 문제
    const javaQuestions = allQuestions.filter(q => q.category === 'Java');
    renderQuestionList(prefix + 'JavaQuestionList', javaQuestions, prefix + 'JavaCount', mode);
    // Database 문제
    const databaseQuestions = allQuestions.filter(q => q.category === 'Database');
    renderQuestionList(prefix + 'DatabaseQuestionList', databaseQuestions, prefix + 'DatabaseCount', mode);
    // 문제해결 문제
    const problemSolvingQuestions = allQuestions.filter(q => q.category === '문제해결');
    renderQuestionList(prefix + 'ProblemSolvingQuestionList', problemSolvingQuestions, prefix + 'ProblemSolvingCount', mode);
    updateTotalSelectedCount(mode);
}

function renderQuestionList(containerId, questions, countId, mode) {
    const container = document.getElementById(containerId);
    const countElement = document.getElementById(countId);
    if (!container) return;
    container.innerHTML = '';
    if (!questions || questions.length === 0) {
        container.innerHTML = '<div class="text-danger">등록된 문제가 없습니다.</div>';
        if (countElement) countElement.textContent = 0;
        return;
    }
    questions.forEach(question => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'form-check mb-2';
        questionDiv.innerHTML = `
            <input class="form-check-input question-checkbox" type="checkbox" 
                   value="${question.id}" id="${containerId.replace('QuestionList','q_')}${question.id}" 
                   data-category="${question.category}">
            <label class="form-check-label" for="${containerId.replace('QuestionList','q_')}${question.id}">
                <small>${question.question.substring(0, 60)}${question.question.length > 60 ? '...' : ''}</small>
                <span class="badge bg-secondary ms-1">${question.type}</span>
                <span class="badge bg-info ms-1">${question.difficulty}</span>
            </label>
        `;
        container.appendChild(questionDiv);
        const checkbox = questionDiv.querySelector('.question-checkbox');
        checkbox.addEventListener('change', () => {
            updateCategoryCount(container, countElement);
            updateTotalSelectedCount(mode);
        });
    });
    setupCategorySelectAll(container, countElement, mode);
}

function setupCategorySelectAll(container, countElement, mode) {
    const selectAllCheckbox = container.parentElement.querySelector('input[type="checkbox"]');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const checkboxes = container.querySelectorAll('.question-checkbox');
            checkboxes.forEach(cb => cb.checked = this.checked);
            updateCategoryCount(container, countElement);
            updateTotalSelectedCount(mode);
        });
    }
}

function updateCategoryCount(container, countElement) {
    const checkedCount = container.querySelectorAll('.question-checkbox:checked').length;
    if (countElement) countElement.textContent = checkedCount;
}

function updateTotalSelectedCount(mode) {
    const prefix = mode === 'edit' ? 'edit' : '';
    const countElement = document.getElementById(prefix + 'TotalSelectedCount');
    if (!countElement) return;
    const javaCount = parseInt(document.getElementById(prefix + 'JavaCount').textContent) || 0;
    const databaseCount = parseInt(document.getElementById(prefix + 'DatabaseCount').textContent) || 0;
    const problemSolvingCount = parseInt(document.getElementById(prefix + 'ProblemSolvingCount').textContent) || 0;
    const total = javaCount + databaseCount + problemSolvingCount;
    countElement.textContent = total;
}

function updateTotalRandomCount() {
    const javaCount = parseInt(document.querySelector('input[name="random_java"]').value) || 0;
    const databaseCount = parseInt(document.querySelector('input[name="random_database"]').value) || 0;
    const problemSolvingCount = parseInt(document.querySelector('input[name="random_problem_solving"]').value) || 0;
    const total = javaCount + databaseCount + problemSolvingCount;
    document.getElementById('totalRandomCount').value = total;
}
function updateEditTotalRandomCount() {
    const javaCount = parseInt(document.querySelector('input[name="edit_random_java"]').value) || 0;
    const databaseCount = parseInt(document.querySelector('input[name="edit_random_database"]').value) || 0;
    const problemSolvingCount = parseInt(document.querySelector('input[name="edit_random_problem_solving"]').value) || 0;
    const total = javaCount + databaseCount + problemSolvingCount;
    document.getElementById('editTotalRandomCount').value = total;
}

function handleQuestionSelectionChange(value, mode) {
    const prefix = mode === 'edit' ? 'edit' : '';
    const randomOptions = document.getElementById(prefix + 'RandomOptions');
    const customOptions = document.getElementById(prefix + 'CustomOptions');
    if (value === 'random') {
        randomOptions.style.display = 'block';
        customOptions.style.display = 'none';
        if (mode === 'add') updateTotalRandomCount();
        else updateEditTotalRandomCount();
    } else if (value === 'custom') {
        randomOptions.style.display = 'none';
        customOptions.style.display = 'block';
        fetchQuestionsAndRender(mode);
    } else {
        randomOptions.style.display = 'none';
        customOptions.style.display = 'none';
    }
}

function setupEventListeners() {
    document.querySelectorAll('input[name="question_selection"]').forEach(radio => {
        radio.addEventListener('change', function() {
            handleQuestionSelectionChange(this.value, 'add');
        });
    });
    document.querySelectorAll('input[name="edit_question_selection"]').forEach(radio => {
        radio.addEventListener('change', function() {
            handleQuestionSelectionChange(this.value, 'edit');
        });
    });
    ['random_java', 'random_database', 'random_problem_solving'].forEach(name => {
        const input = document.querySelector(`input[name="${name}"]`);
        if (input) input.addEventListener('input', updateTotalRandomCount);
    });
    ['edit_random_java', 'edit_random_database', 'edit_random_problem_solving'].forEach(name => {
        const input = document.querySelector(`input[name="${name}"]`);
        if (input) input.addEventListener('input', updateEditTotalRandomCount);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();

    // 지원자 추가 모달이 열릴 때마다 문제 목록 렌더링
    const addCandidateModal = document.getElementById('addCandidateModal');
    if (addCandidateModal) {
        addCandidateModal.addEventListener('show.bs.modal', function() {
            fetchQuestionsAndRender('add');
        });
    }

    // 지원자 추가 폼 submit 이벤트
    document.getElementById('addCandidateForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const form = this;
        const name = form.name.value.trim();
        const access_date = form.access_date.value;
        const test_duration = form.test_duration.value;
        // 문제 선택 방식 확인
        const selection = form.querySelector('input[name="question_selection"]:checked').value;
        let selected_questions = [];
        if (selection === 'custom') {
            // 직접 선택: 체크된 문제 id 모두 수집
            selected_questions = Array.from(document.querySelectorAll('#customOptions .question-checkbox:checked')).map(cb => cb.value);
        } else if (selection === 'random') {
            // 랜덤 선택: 카테고리별 개수만큼 랜덤 id 요청
            const javaCount = parseInt(form.random_java.value) || 0;
            const dbCount = parseInt(form.random_database.value) || 0;
            const psCount = parseInt(form.random_problem_solving.value) || 0;
            // 한글 주석: 서버에 랜덤 문제 id 요청 (동기 처리)
            fetch(`/api/random_questions?java=${javaCount}&database=${dbCount}&problem_solving=${psCount}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        selected_questions = data.selected_questions;
                        submitCandidate({name, access_date, test_duration, selected_questions});
                    } else {
                        alert('랜덤 문제 선택 오류: ' + (data.message || '서버 오류'));
                    }
                })
                .catch(() => alert('랜덤 문제 선택 중 오류가 발생했습니다.'));
            return;
        } else if (selection === 'all') {
            // 전체 문제: 모든 문제 id
            selected_questions = allQuestions.map(q => q.id);
        } else if (selection === 'none') {
            // 문제 선택 안함: 빈 배열
            selected_questions = [];
        }
        // 직접 선택/전체/없음은 바로 전송
        submitCandidate({name, access_date, test_duration, selected_questions});
    });

    // 지원자 추가 ajax 함수
    function submitCandidate(payload) {
        fetch('/admin/candidate/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // 성공 시 모달 닫고 새로고침
                const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('addCandidateModal'));
                modal.hide();
                location.reload();
            } else {
                alert('등록 실패: ' + (data.message || '서버 오류'));
            }
        })
        .catch(() => alert('등록 중 오류가 발생했습니다.'));
    }
});
</script>
{% endblock %}