{% extends "base.html" %}

{% block title %}지원자-문제 매칭{% endblock %}

{% block head %}
<style>
    .match-container {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 20px;
        height: calc(100vh - 200px);
    }
    .candidate-list, .question-list {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 15px;
        overflow-y: auto;
    }
    .candidate-list .list-group-item {
        cursor: pointer;
    }
    .candidate-list .list-group-item.active {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    .question-item {
        padding: 8px;
        border-bottom: 1px solid #eee;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="fas fa-link"></i> 지원자-문제 매칭</h2>
        <div>
            <a href="{{ url_for('admin') }}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> 관리자 페이지로</a>
            <button id="save-btn" class="btn btn-success" disabled><i class="fas fa-save"></i> 변경사항 저장</button>
            <button id="ai-generate-btn" class="btn btn-primary" disabled><i class="fas fa-robot"></i> AI 맞춤질문 생성</button>
        </div>
    </div>

    <div class="match-container">
        <!-- 지원자 목록 -->
        <div class="candidate-list">
            <h5>지원자 목록</h5>
            <div class="list-group">
                {% for candidate in candidates %}
                <a href="#" class="list-group-item list-group-item-action" 
                   data-candidate-id="{{ candidate.id }}" 
                   data-department-id="{{ candidate.department_id or '' }}"
                   data-selected-questions='{{ candidate.selected_questions | tojson | safe }}'>
                    {{ candidate.name }}
                    <small class="d-block text-muted">{{ department_map.get(candidate.department_id, '부서 미지정') }}</small>
                </a>
                {% endfor %}
            </div>
        </div>

        <!-- 문제 목록 -->
        <div class="question-list">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5>문제 목록 <span id="selected-candidate-name" class="text-primary"></span></h5>
                <div>
                    <input type="checkbox" id="check-all">
                    <label for="check-all">전체 선택/해제</label>
                </div>
            </div>
            <div id="questions-container">
                <p class="text-muted">왼쪽에서 지원자를 선택하세요.</p>
                {% for question in questions %}
                <div class="question-item" data-question-id="{{ question.id }}" data-department-id="{{ question.department_id or '' }}" style="display: none;">
                    <input type="checkbox" class="question-checkbox" value="{{ question.id }}" id="q-{{question.id}}">
                    <label for="q-{{question.id}}">{{ question.question }}</label>
                    <span class="badge bg-primary">{{ question.category }}</span>
                    <span class="badge bg-secondary">{{ question.type }}</span>
                </div>
                {% endfor %}
            </div>
            <div id="ai-questions-area" class="mt-3" style="display:none;">
                <h6>AI 맞춤형 면접 질문</h6>
                <div id="ai-questions-result" class="border rounded p-2 bg-light"></div>
                <button id="copy-questions-btn" class="btn btn-outline-secondary btn-sm mt-2">질문 복사</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    let currentCandidateId = null;
    const candidateLinks = document.querySelectorAll('.candidate-list .list-group-item');
    const questionsContainer = document.getElementById('questions-container');
    const allQuestionItems = Array.from(questionsContainer.querySelectorAll('.question-item')); // 원본 문제 아이템들
    const checkAll = document.getElementById('check-all');
    const saveBtn = document.getElementById('save-btn');
    const placeholder = questionsContainer.querySelector('p');
    const aiBtn = document.getElementById('ai-generate-btn');
    const aiArea = document.getElementById('ai-questions-area');
    const aiResult = document.getElementById('ai-questions-result');
    const copyBtn = document.getElementById('copy-questions-btn');

    candidateLinks.forEach(link => {
        link.addEventListener('click', function (e) {
            e.preventDefault();

            candidateLinks.forEach(l => l.classList.remove('active'));
            this.classList.add('active');

            currentCandidateId = this.dataset.candidateId;
            const departmentId = this.dataset.departmentId;
            const selectedQuestions = JSON.parse(this.dataset.selectedQuestions);

            document.getElementById('selected-candidate-name').textContent = `(${this.textContent.trim().split('\\n')[0]})`;
            saveBtn.disabled = false;
            aiBtn.disabled = false;
            aiArea.style.display = 'none';
            aiResult.textContent = '';
            
            let hasVisibleQuestions = false;
            allQuestionItems.forEach(item => {
                const isVisible = item.dataset.departmentId === departmentId;
                item.style.display = isVisible ? 'block' : 'none';
                if (isVisible) {
                    hasVisibleQuestions = true;
                    item.querySelector('.question-checkbox').checked = selectedQuestions.includes(item.dataset.questionId);
                }
            });

            placeholder.style.display = hasVisibleQuestions ? 'none' : 'block';
            if (!hasVisibleQuestions) {
                placeholder.textContent = '이 지원자의 부서에 할당된 문제가 없습니다.';
            }
        });
    });

    // 전체 선택/해제
    checkAll.addEventListener('change', function() {
        allQuestionItems.forEach(item => {
            // 보이는 항목에 대해서만 전체 선택/해제 적용
            if (item.style.display !== 'none') {
                item.querySelector('.question-checkbox').checked = this.checked;
            }
        });
    });

    // 저장 버튼 클릭
    saveBtn.addEventListener('click', function() {
        if (!currentCandidateId) {
            alert('먼저 지원자를 선택해주세요.');
            return;
        }

        const selectedIds = allQuestionItems
            .filter(item => item.querySelector('.question-checkbox').checked)
            .map(item => item.dataset.questionId);

        fetch(`/api/candidate/${currentCandidateId}/questions/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question_ids: selectedIds })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('성공적으로 저장되었습니다.');
                const activeLink = document.querySelector('.candidate-list .list-group-item.active');
                if (activeLink) {
                    activeLink.dataset.selectedQuestions = JSON.stringify(selectedIds);
                }
            } else {
                alert('저장 실패: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('저장 중 오류가 발생했습니다.');
        });
    });

    aiBtn.addEventListener('click', function() {
        if (!currentCandidateId) {
            alert('먼저 지원자를 선택해주세요.');
            return;
        }
        aiBtn.disabled = true;
        aiBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 생성 중...';
        fetch(`/api/candidate/${currentCandidateId}/generate_questions`, {
            method: 'POST',
        })
        .then(response => response.json())
        .then(data => {
            aiBtn.disabled = false;
            aiBtn.innerHTML = '<i class="fas fa-robot"></i> AI 맞춤질문 생성';
            if (data.success) {
                aiArea.style.display = 'block';
                aiResult.textContent = data.questions;
            } else {
                aiArea.style.display = 'block';
                aiResult.textContent = data.message;
            }
        })
        .catch(error => {
            aiBtn.disabled = false;
            aiBtn.innerHTML = '<i class="fas fa-robot"></i> AI 맞춤질문 생성';
            aiArea.style.display = 'block';
            aiResult.textContent = '질문 생성 중 오류가 발생했습니다.';
        });
    });

    copyBtn.addEventListener('click', function() {
        const text = aiResult.textContent;
        navigator.clipboard.writeText(text).then(() => {
            alert('질문이 복사되었습니다!');
        });
    });
});
</script>
{% endblock %} 